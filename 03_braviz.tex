
The ideas reflected in the previous chapters were implemented into a software platform called Braviz. This software is licensed under a LGPL license and its source code and documentation can be found online at http://diego0020.github.io/braviz . As suggested by user centered design, the software was the result of several iterations. The architecture of the software reflects the model described in chapter \ref{chap_model}. Details of these aspects will be given in the following. Finally we will describe some of the more technical details of the software.

\section{Iterations}


%Iterations
%-------------

%- Feedback
%- changes
%- evidence of user centered design

The development of the platform went trough several prototypes that were tested with target users. From each prototype several lessons were learned, both from the technical point and from the users feedback. Each iteration brings new ideas and challenges to the project. As the process goes on prototypes become more sophisticated. At the start changes occur very fast, while at the process goes on changes are smaller and take longer. The whole process can be seen as a spiral (see figure \ref{intro_spiral}). This section will provide an overview of each of the iterations up to the current point, and show the more significant insights and changes from each of them. Notice that the process has not stopped, and we expect the platform to continue evolving. Chapter \ref{chap_conclusions} will provide details of the plans for future iterations.

\subsection{Previous Work}

\begin{figure}
\centering
\includegraphics[width=0.9\textwidth]{historic/kab_figura1.png} 
\caption{\label{fig_kab}The main interface of KAB}
\end{figure}

The first prototype built by our group was called KAB \autocite{castro_kab:_2012}. This tool was built to analyze data from the KMC pilot study \autocite{schneider_cerebral_2012}. This software integrated data from Diffusion MRI, Functional MRI and structural MRI. The main interface of the tool is shown in figure \ref{fig_kab}. Data was pre-processed using FSL \autocite{jenkinson_fsl_2012} for skull removal and FMRI modeling, and Medinria \autocite{toussaint_medinria} for diffusion data. Registration between diffusion and structural spaces was done on-line using the tool itself. The most important features of the software were:

\begin{itemize}
\item Visualizing structural MRI, fMRI and tractography on the same space
\item Selection of bundles in a full tractography
\begin{itemize}
\item Using two spherical regions of interests located manually
\item Using conical regions of interests, representing the spread of TMS magnetic pulses
\item Using areas where fMRI statistics were above a threshold
\item Using hand-drawn regions
\end{itemize}
\item Generating statistics from selected bundles
\item Automatic generation of reports
\end{itemize}

Integrating information from different sources was the major contribution of the tool. Traditionally each type of data was analyzed on its own, using dedicated tools, and integrating information in this way was beyond brain experts. This tool was implemented based on the BBTK framework \autocite{hoyos_creatools} developed by Creatis. 

Specialists appreciated the ability to integrate several kinds of data and ask questions that involved relationships between them. During the development of the application specialists started asking questions about symmetries in the brain, and therefore the option of reflecting a ROI to the other hemisphere was added. Specialists also expressed the need of linking the coordinate system of the tool to a known atlas.

While this tool made evident the interest in integrated analysis of data, it also had some limitations.
\begin{itemize}
\item It required too much manual work, often repeating tasks
\item It had too many features in a single application, which made it complex
\item Manual registration was very error prone
\item It didn't integrate non-image data.
\end{itemize}
Based on these we proposed a new set of prototypes.

\subsection{First prototypes}

%-- titanic

For the first round of prototypes after KAB, we focused on creating tools with a limited set of features, which could run faster and be easier to learn. We stayed with the BBTK framework as it provided us a fast way to iterate. At this stage our main objectives were solving the technical problems we identified in KAB. Specifically
\begin{itemize}
\item Perform registration automatically
\item Integrate non-image data
\item Increase computational performance
\end{itemize}

\begin{figure}
\centering
\includegraphics[width=0.9\textwidth]{historic/Titanic_B.png} 
\caption{\label{fig_titanic}Prototype integrating tabular and image data}
\end{figure}

Most of the prototypes created at this stage were only used internally to test different algorithms and techniques. Figure \ref{fig_titanic} shows the final prototype of this series. Its main features are
\begin{itemize}
\item Display values of clinical variables together with the image
\item Explicit identification of the current subject
\item Simple interface
\item Selection of different image modalities
\item Selection of different coloring schemes for bundles
\item Direct selection of the most important fiber groups
\item Control on most important visualization parameters
\end{itemize}

\begin{figure}
\centering
\includegraphics[width=0.9\textwidth]{historic/Titanic.png} 
\caption{\label{fig_titanic_2}The prototype could be configured to show several images and to color fibers in different ways.}
\end{figure}

Figure \ref{fig_titanic_2} shows several of the views that could be accomplished with this tool.
The tool was simple to use as there were few controls and all of them were visible. Notice this application was tailored towards the specific project. At the time the research team was specially interested in corpus callosum and motor fibers. This application allowed researchers to quickly answer specific questions relating fiber bundles to clinical variables. Also now researchers from all specialists could look at tractography and a different MRI images painlessly, where before they had to rely on large, hard to use applications. Data was organized in drive in a well defined structure. When the application launches the user only needed to select the main structural image, and the rest of the necessary files were located trough their relative paths. There was no need for end user to even know about the existence of transformation matrices or other files. This simplified a lot the process of simply looking at spatial data in context, and allowed experts to do this in a convenient way. Having a more direct access to spatial data allowed experts from different specialties to look at them on their own time, and therefore come up with new ideas for analyzes. They were also using the tool to communicate ideas to other brain experts and also to us. We now had a better way of communicating with experts, and therefore we could get a better understanding of their needs. This tool showed us the potential of integrating spatial data with clinical data, but some limitations were made evident in our work with experts
\begin{itemize}
\item It was not possible to change subject during an analysis
\item It was not easy to select different variables
\item It was not possible to use different sets of tracks
\item It is cumbersome to compare different subjects
\end{itemize}

Analyzing groups of subjects and comparing subjects became the priority for the next round.

\subsection{Braviz, First Version}

%- Braviz/tk
%-- sample applications

For the next cycle we dropped the BBTK platform as we found out it was limiting too much our design space. The platform enforced an execution model that kept everything updated. This was great for small applications, that were meant to run for just a couple of minutes. However for large applications that could run for hours we required more control of when the different modules would execute. BBTK relied on VTK for all visualization tasks, and therefor we decided to start developing directly on VTK. However it was still very important to us to have quick development cycles, and we were willing to sacrifice some performance to get it, therefore we switched our main developing language to python. In the following we will describe some of the applications developed at this stage. 

We were exploring how to bring into the applications of more sophisticated processing tools. FreeSurfer specially grabbed our attention as it provided information from an ATLAS, and provided a way to identify the different regions of the brain using common names. This was very important to experts as it allowed them to compare their finding to those of other groups, and those in the literature. Figure \ref{fig_surf_1} shows one of the prototypes which allowed experts to visualize FreeSurfer surface parcellations. This application has a 3D viewer on the right side and a control panel on the left side. The bottom part of this panel lets the user select the different FreeSurfer surfaces and scalars, while the top of the panel lets him show a subject. Notice that it is now possible to change the subject in the middle of a session, and by doing so, it is also easier to compare the same view for multiple subjects. This was one of the main goals at this stage. 

\begin{figure}
\centering
\includegraphics[width=0.9\textwidth]{historic/surf1.png} 
\caption{\label{fig_surf_1}A freesurfer surface inside Braviz}
\end{figure}

The FreeSurfer segmentations also provided us a repeatable way of selecting fibers across all subjects. Figure \ref{fig_cc_ctx_1} shows an application designed for this task. In the control panel we now have a list of structures where the user can select one or several. In the middle of the panel is a combo-box which provides the options "\emph{or}" or "\emph{and}". This selection will change the way in which multiple selections are interpreted, in the case of \emph{or}, fibers that go trough any of the structures will be selected, while in the case of \emph{and} only fibers that go trough all of them will be selected. Notice there is another combo-box labeled "\emph{coordinates}", this box provides the options "\emph{world}", "\emph{talairach}" and "\emph{dartel}". In "\emph{world}" objects on the 3D view are represented based on the coordinates of the anatomical image, in "\emph{talairach}" mode the coordinates change to the standard Talairach space and, in "\emph{dartel}" mode, objects are registered to sample template using a non-linear registration. By moving to a standard space comparing two different subjects is easier, as some of the differences will be absorbed by the transformation. This will enhance some types of differences but will hide some others; the most appropriate coordinate system will depend on what types of differences are currently of interest for the end user. In this application several other FreeSurfer structures could be added to the scene in order to provide context. Figure \ref{fig_fibers_ctx} shows another view of this application. By hovering the cursor on top of a bundle the user could get some information about them. It was also possible to measure distances in the 3D space in order to make numeric comparisons across subjects.

\begin{figure}
\centering
\includegraphics[width=0.9\textwidth]{historic/cc_in_context.png} 
\caption{\label{fig_cc_ctx_1}Fibers of the corpus callosum with segmentation and anatomical image as context}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=0.9\textwidth]{historic/fibers_in_context.png} 
\caption{\label{fig_fibers_ctx}Fibers could be selected using freesurfer segmentation. Vtk widgets could be used to make measurements.
Additionally statistics of each bundle were also available.}
\end{figure}

An application for viewing two subjects at the same time and comparing them was also created. Its interface can be seen on figure \ref{fig_compare_1}. In this application it was possible to show the same selection of images, fibers and structures for two different subjects. The screen could be split vertically, horizontally or both subjects could be shown on the same space but using different colors and possibly adding a small offset.

\begin{figure}
\centering
\includegraphics[width=0.9\textwidth]{historic/compare.png} 
\caption{\label{fig_compare_1}Comparing the motor tract of two subjects}
\end{figure}

At this point the interest in fMRI was increasing, but some of the researchers who were not expert on this technique were having problems interpreting this data correctly. Figure \ref{fig_fmri_1} shows an application created to make the nature of fMRI explicit. The application shows the T-score image in the 3D view, but also shows the corresponding time signal at each voxel, together with the experiment design. In this way users could better understand that a higher score meant a larger relationship between the BOLD signal an the paradigm. 

\begin{figure}
\centering
\includegraphics[width=0.9\textwidth]{historic/rejean2.png} 
\caption{\label{fig_fmri_1}This prototypes make the time dimension of fMRI explicit, therefore helping non-experts understand its meaning and make better interpretations}
\end{figure}

We wanted to let researchers search for patterns between clinical variables and structures. One proposal in this direction can be seen in figure \ref{fig_grid}, this application shows the corpus callosums of all subjects in the study organized in a grid. From left to right the structures are organized according to a clinical variable, while the color of the structures reflect the value of another clinical variable. The variables used for these purposes could be selected from the panel on the left. At the bottom right of the viewer was a small scatter plot showing the relationships between the two variables. This plot was linked to the grid view, so selecting a point in the plot would highlight the corresponding structure and vice versa. Another important feature was that an individual structure could be rotated in 3d space, and the rotations would be propagate to all the structures on the grid.

\begin{figure}
\centering
\includegraphics[width=0.9\textwidth]{historic/grid_and_scatter.png} 
\caption{\label{fig_grid}Corpus Callosums of several subjects organized on a grid and colored with respect to clinical variables.
A scatter plot of these variables is shown at the bottom left}
\end{figure}

Another proposal for showing relationships between structures and clinical variables is shown in figure \ref{fig_star_1}. In this case structures and data are separated in three groups. This grouping is done by the main categorical variable in the study (see chapter \ref{chap_kmc}). Clinical data is shown using a spider plot, where each subject is represented as a polygon and each variable is an axis. Structures are shown on the same space using alpha-blending. By mixing all the structures in this way the average shape for the group appears. Also notice variables are organized in a tree like structure on the top left, and the description of each variable appears when the user hovers on its name. This tree also showed FreeSurfer structures and allowed the user to add the volumes and areas of such structures to the star plot. As in the previous case there was an integration between the numerical variables and the structure, and clicking on one would highlight the corresponding subject on both views.

\begin{figure}
\centering
\includegraphics[width=0.9\textwidth]{historic/mini_star.png} 
\caption{\label{fig_star_1}This application allowed comparing several structures and variables between groups of subjects.}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=0.9\textwidth]{historic/mini_tms.png} 
\caption{\label{fig_tms_1}An application tailored at analyzing TMS variables relationship with tractography}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=0.9\textwidth]{historic/braviz_menu.png} 
\caption{\label{fig_menu_1}A menu was provided to give an overview of the available applications and provide simple access.}
\end{figure}

%Feedback

\subsection{Braviz, Second Version}

%- Braviz Qt
%-- sample applications


\section{Architecture}

From model to implementation
-----------------------------

- architecture
- common platform
- skeleton of a application
- database


\section{Technical Details}

Technical details
------------------

- organization
- libraries
- messaging protocol
- data input/output
- transformations
- coordinate systems



